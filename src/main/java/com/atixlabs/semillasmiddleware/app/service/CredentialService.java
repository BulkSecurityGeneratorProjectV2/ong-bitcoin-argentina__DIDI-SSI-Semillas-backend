package com.atixlabs.semillasmiddleware.app.service;

import com.atixlabs.semillasmiddleware.app.model.beneficiary.Person;
import com.atixlabs.semillasmiddleware.app.model.credential.CredentialCredit;
import com.atixlabs.semillasmiddleware.app.repository.CredentialCreditRepository;
import com.atixlabs.semillasmiddleware.excelparser.app.categories.BeneficiaryCategory;
import com.atixlabs.semillasmiddleware.excelparser.app.dto.SurveyForm;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.xml.catalog.CatalogException;
import java.time.LocalDateTime;

@Slf4j
@Service
public class CredentialService {

    @Autowired
    private CredentialCreditRepository credentialCreditRepository;

    public void buildAllCredentialsFromForm(SurveyForm surveyForm)
    {
        log.info("buildCredentials: "+this.toString());
        buildPerson(surveyForm);
        buildCreditCredential(surveyForm);
    }

    /**
     * The following are non-public methods, isolating functionality.
     * to make public methods easier to read.
     * @param surveyForm
     */
    private void buildPerson(SurveyForm surveyForm){
        log.info("buildPerson");
        Person person = new Person();
        person.setName("pablo");
        person.setDocumentType("DNI");
        //person.setDocumentNumber();
    }

    private void buildCreditCredential(SurveyForm surveyForm){
        log.info("buildCreditCredential");
        BeneficiaryCategory beneficiaryCategory = (BeneficiaryCategory) surveyForm.getCategoryData(BeneficiaryCategory.class);

        if(beneficiaryCategory != null) {
            CredentialCredit credentialCredit = new CredentialCredit();
            credentialCredit.setDniBeneficiary(beneficiaryCategory.getNumeroDocumento());
            this.saveCredentialCredit(credentialCredit);
        }
    }

    private void saveCredentialCredit(CredentialCredit credentialCredit){
        credentialCredit.setDateOfExpiry(LocalDateTime.now());
        credentialCredit.setDateOfIssue(LocalDateTime.now());
        credentialCredit.setCurrentCycle("imported-from-excel");
        credentialCredit.setCreditState("pre-credential");
        log.info(credentialCredit.toString());
        credentialCreditRepository.save(credentialCredit);
    }

    public void saveCredentialCreditMock(){
        CredentialCredit credentialCredit = new CredentialCredit();
        credentialCredit.setDateOfExpiry(LocalDateTime.now());
        credentialCredit.setDateOfIssue(LocalDateTime.now());

        //credentialCredit.setId(1L);//autogenerated
        //credentialCredit.setIdDidiCredential(456L);//null because must be completed by didi
        //credentialCredit.setIdDidiIssuer(123L);//null must be completed by didi
        //credentialCredit.setIdDidiReceptor(234L);//null must be completed by didi
        //credentialCredit.setIdHistorical(77L);//null must be completed by didi
        //credentialCredit.setIdRelatedCredential(534L);//tbd value

        credentialCredit.setCreditName("credit name");
        credentialCredit.setIdGroup(1111L);
        credentialCredit.setGroupName("GroupName");
        credentialCredit.setRol("rol");
        credentialCredit.setAmount(1d);
        credentialCredit.setCurrentCycle("Cycle");
        credentialCredit.setCreditState("state");
        credentialCredit.setDniBeneficiary(29302594L);
        credentialCreditRepository.save(credentialCredit);
    }




}
